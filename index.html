<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0Grf96gKPyhs3AGnE5tnu1oxPi4mn9nw",
    authDomain: "vsg-buddy.firebaseapp.com",
    projectId: "vsg-buddy",
    storageBucket: "vsg-buddy.firebasestorage.app",
    messagingSenderId: "835934469982",
    appId: "1:835934469982:web:ca9abc795a8c600256d9cf",
    measurementId: "G-NJEDXSX3KQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  // Local storage keys renamed to match new brand
  const STORAGE_KEY = "vsgBuddyData";
  const SETTINGS_KEY = "vsgBuddySettings";
  // New key so the donation prompt can show again even if the old one was hidden
  const DONATE_HIDE_KEY = "vsgBuddyHideDonatePrompt_v2";

  const GOALS = { water: 64, protein: 60, walk: 20 };

  // DOM refs
  const loginPage = document.getElementById("loginPage");
  const appMain = document.getElementById("appMain");

  const authEmailInput = document.getElementById("authEmail");
  const authPasswordInput = document.getElementById("authPassword");
  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");

  const dateInput = document.getElementById("date");
  const waterInput = document.getElementById("water");
  const proteinInput = document.getElementById("protein");
  const weightInput = document.getElementById("weight");
  const walkInput = document.getElementById("walk");
  const medsInput = document.getElementById("meds");
  const notesInput = document.getElementById("notes");

  const saveBtn = document.getElementById("saveBtn");
  const clearBtn = document.getElementById("clearBtn");
  const goToProgressBtn = document.getElementById("goToProgressBtn");
  const downloadJsonBtn = document.getElementById("downloadJsonBtn");
  const backupJsonBtn = document.getElementById("backupJsonBtn");
  const restoreJsonInput = document.getElementById("restoreJsonInput");

  const summaryDiv = document.getElementById("summary");
  const navTabs = document.querySelectorAll(".nav-tab");
  const pages = document.querySelectorAll(".page");
  const quoteText = document.getElementById("quoteText");
  const quoteDate = document.getElementById("quoteDate");
  const noDataMsg = document.getElementById("noDataMsg");

  const menuToggle = document.getElementById("menuToggle");
  const sideMenu = document.getElementById("sideMenu");
  const closeMenuBtn = document.getElementById("closeMenuBtn");
  const topAuthStatus = document.getElementById("topAuthStatus");
  const sideAuthStatus = document.getElementById("sideAuthStatus");
  const logoutBtn = document.getElementById("logoutBtn");

  const waterRingCircle = document.getElementById("waterRingCircle");
  const proteinRingCircle = document.getElementById("proteinRingCircle");
  const walkRingCircle = document.getElementById("walkRingCircle");
  const waterRingPercent = document.getElementById("waterRingPercent");
  const proteinRingPercent = document.getElementById("proteinRingPercent");
  const walkRingPercent = document.getElementById("walkRingPercent");

  const weeklySummaryDiv = document.getElementById("weeklySummary");
  const streaksSummaryDiv = document.getElementById("streaksSummary");
  const surgeryDateInput = document.getElementById("surgeryDateInput");
  const goalWeightInput = document.getElementById("goalWeightInput");
  const saveJourneyBtn = document.getElementById("saveJourneyBtn");
  const journeySummaryDiv = document.getElementById("journeySummary");

  const themeButtons = document.querySelectorAll(".theme-btn");

  const donationPrompt = document.getElementById("donationPrompt");
  const donationCloseBtn = document.getElementById("donationCloseBtn");
  const donationSupportBtn = document.getElementById("donationSupportBtn");
  const donationLaterBtn = document.getElementById("donationLaterBtn");
  const donationNeverBtn = document.getElementById("donationNeverBtn");

  const toastEl = document.getElementById("toast");

  let currentUser = null;
  let weightChart, waterChart, proteinChart, walkChart;
  let appSettings = {};

  const THEMES = {
    calm: {
      "--bg-gradient": "linear-gradient(135deg, #e3f2fd, #e8f5e9)",
      "--accent": "#4f8cff",
      "--accent-soft": "#e3edff",
      "--accent-strong": "#2f5fd6",
      "--card-bg": "rgba(255, 255, 255, 0.95)",
      "--text-main": "#1f2933",
      "--text-muted": "#6b7b8c"
    },
    sunrise: {
      "--bg-gradient": "linear-gradient(135deg, #ffe4e1, #fff3cd)",
      "--accent": "#ff8c69",
      "--accent-soft": "#ffe0d6",
      "--accent-strong": "#e6693e",
      "--card-bg": "rgba(255, 255, 255, 0.96)",
      "--text-main": "#3f2a2a",
      "--text-muted": "#8b6b5c"
    },
    midnight: {
      "--bg-gradient": "linear-gradient(135deg, #020617, #111827)",
      "--accent": "#38bdf8",
      "--accent-soft": "#0ea5e9",
      "--accent-strong": "#0284c7",
      "--card-bg": "rgba(15, 23, 42, 0.96)",
      "--text-main": "#e5e7eb",
      "--text-muted": "#9ca3af"
    }
  };

  function getTodayString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, "0");
    const day = String(today.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  function loadAllDataLocal() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return {};
    try { return JSON.parse(stored); } catch { return {}; }
  }

  function saveAllDataLocal(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadSettingsLocal() {
    const stored = localStorage.getItem(SETTINGS_KEY);
    if (!stored) return {};
    try { return JSON.parse(stored); } catch { return {}; }
  }

  function saveSettingsLocal(settings) {
    appSettings = settings;
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  async function loadAllDataCloud() {
    if (!currentUser) return {};
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (!snap.exists()) return {};
    return snap.data().days || {};
  }

  async function saveAllDataCloud(data) {
    if (!currentUser) return;
    await setDoc(
      doc(db, "users", currentUser.uid),
      { days: data },
      { merge: true }
    );
  }

  function updateProgressRings(dayData) {
    const water = dayData?.water || 0;
    const protein = dayData?.protein || 0;
    const walk = dayData?.walk || 0;

    function setRing(circleEl, percentEl, value, goal) {
      if (!circleEl || !percentEl) return;
      const pct = goal > 0 ? Math.min(100, Math.round((value / goal) * 100)) : 0;
      const angle = pct * 3.6;
      circleEl.style.background =
        `conic-gradient(var(--accent) ${angle}deg, #e5edf7 0deg)`;
      percentEl.textContent = pct + "%";
    }

    setRing(waterRingCircle, waterRingPercent, water, GOALS.water);
    setRing(proteinRingCircle, proteinRingPercent, protein, GOALS.protein);
    setRing(walkRingCircle, walkRingPercent, walk, GOALS.walk);
  }

  async function loadDataForDate(dateStr) {
    let allData = loadAllDataLocal();

    if (currentUser) {
      try {
        const cloudData = await loadAllDataCloud();
        allData = { ...allData, ...cloudData };
        saveAllDataLocal(allData);
      } catch (e) {
        console.error("Error loading from cloud:", e);
      }
    }

    const dayData = allData[dateStr];

    if (dayData) {
      waterInput.value = dayData.water ?? "";
      proteinInput.value = dayData.protein ?? "";
      weightInput.value = dayData.weight ?? "";
      walkInput.value = dayData.walk ?? "";
      medsInput.checked = !!dayData.meds;
      notesInput.value = dayData.notes ?? "";
      updateSummary(dayData);
      updateProgressRings(dayData);
    } else {
      waterInput.value = "";
      proteinInput.value = "";
      weightInput.value = "";
      walkInput.value = "";
      medsInput.checked = false;
      notesInput.value = "";
      summaryDiv.innerHTML =
        '<p class="notes-empty">No data saved for this date yet.</p>';
      updateProgressRings(null);
    }
  }

  function updateSummary(dayData) {
    const medsText = dayData.meds ? "‚úÖ Took medicine" : "‚ö†Ô∏è Medicine not logged";

    summaryDiv.innerHTML = `
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Water</div>
          <div class="summary-value">${dayData.water || 0} oz</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Protein</div>
          <div class="summary-value">${dayData.protein || 0} g</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Weight</div>
          <div class="summary-value">
            ${dayData.weight != null ? dayData.weight + " lbs" : "Not logged"}
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Walk</div>
          <div class="summary-value">${dayData.walk || 0} min</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Medication</div>
          <div class="summary-value">${medsText}</div>
        </div>
      </div>
      <div class="notes-box">
        <strong>Notes:</strong>
        <div class="${dayData.notes ? "" : "notes-empty"}">
          ${dayData.notes ? dayData.notes : "No notes added for today."}
        </div>
      </div>
    `;
  }

  function showPageById(id) {
    pages.forEach(page => page.classList.add("hidden"));
    navTabs.forEach(tab => tab.classList.remove("active"));

    const pageToShow = document.getElementById(id);
    if (pageToShow) pageToShow.classList.remove("hidden");

    navTabs.forEach(tab => {
      if (tab.dataset.target === id) tab.classList.add("active");
    });

    if (id === "progressPage") {
      buildCharts();
      buildWeeklySummary();
      buildStreaksUI();
      updateJourneySummary(appSettings, getSortedDataArray());
    }
  }

  navTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const targetId = tab.dataset.target;
      showPageById(targetId);
    });
  });

  if (goToProgressBtn) {
    goToProgressBtn.addEventListener("click", () => {
      showPageById("progressPage");
    });
  }

  // Slide menu
  if (menuToggle && sideMenu) {
    menuToggle.addEventListener("click", () => {
      sideMenu.classList.add("open");
    });
  }
  if (closeMenuBtn && sideMenu) {
    closeMenuBtn.addEventListener("click", () => {
      sideMenu.classList.remove("open");
    });
  }
  document.addEventListener("click", (e) => {
    if (!sideMenu) return;
    const isInside = sideMenu.contains(e.target);
    const isButton = menuToggle && menuToggle.contains(e.target);
    if (!isInside && !isButton) sideMenu.classList.remove("open");
  });

  const quotes = [
    "You are healing, even on the days it doesn‚Äôt feel like it.",
    "Small steps every day add up to a big transformation.",
    "Your future self is already proud of you.",
    "You didn‚Äôt come this far to only come this far.",
    "Progress, not perfection, is the goal.",
    "Your body deserves your patience and kindness.",
    "One day at a time, one choice at a time."
  ];

  function getQuoteOfTheDay() {
    const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 0);
    const diff = today - startOfYear;
    const oneDayMs = 1000 * 60 * 60 * 24;
    const dayOfYear = Math.floor(diff / oneDayMs);
    const index = dayOfYear % quotes.length;
    return quotes[index];
  }

  function updateQuote() {
    if (!quoteText || !quoteDate) return;
    quoteText.textContent = getQuoteOfTheDay();
    quoteDate.textContent = new Date().toLocaleDateString();
  }

  function getSortedDataArray() {
    const allData = loadAllDataLocal();
    const dates = Object.keys(allData).sort();
    return dates.map(date => ({ date, ...allData[date] }));
  }

  function buildCharts() {
    const dataArr = getSortedDataArray();

    const weightPoints = dataArr.filter(d => d.weight != null && !isNaN(Number(d.weight)));
    const waterPoints = dataArr.filter(d => d.water != null && !isNaN(Number(d.water)));
    const proteinPoints = dataArr.filter(d => d.protein != null && !isNaN(Number(d.protein)));
    const walkPoints = dataArr.filter(d => d.walk != null && !isNaN(Number(d.walk)));

    const hasAny =
      weightPoints.length || waterPoints.length || proteinPoints.length || walkPoints.length;

    if (!hasAny) {
      if (weightChart) { weightChart.destroy(); weightChart = null; }
      if (waterChart) { waterChart.destroy(); waterChart = null; }
      if (proteinChart) { proteinChart.destroy(); proteinChart = null; }
      if (walkChart) { walkChart.destroy(); walkChart = null; }
      if (noDataMsg) noDataMsg.style.display = "block";
      return;
    }

    if (noDataMsg) noDataMsg.style.display = "none";

    const ctxWeight = document.getElementById("weightChart").getContext("2d");
    const ctxWater = document.getElementById("waterChart").getContext("2d");
    const ctxProtein = document.getElementById("proteinChart").getContext("2d");
    const ctxWalk = document.getElementById("walkChart").getContext("2d");

    if (weightChart) weightChart.destroy();
    if (waterChart) weightChart = null;
    if (proteinChart) proteinChart.destroy();
    if (walkChart) walkChart.destroy();

    if (weightPoints.length) {
      weightChart = new Chart(ctxWeight, {
        type: "line",
        data: {
          labels: weightPoints.map(d => d.date),
          datasets: [
            { label: "Weight (lbs)", data: weightPoints.map(d => Number(d.weight)), borderWidth: 2, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 7 } } }
        }
      });
    }

    if (waterPoints.length) {
      waterChart = new Chart(ctxWater, {
        type: "line",
        data: {
          labels: waterPoints.map(d => d.date),
          datasets: [
            { label: "Water (oz)", data: waterPoints.map(d => Number(d.water)), borderWidth: 2, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 7 } } }
        }
      });
    }

    if (proteinPoints.length) {
      proteinChart = new Chart(ctxProtein, {
        type: "line",
        data: {
          labels: proteinPoints.map(d => d.date),
          datasets: [
            { label: "Protein (g)", data: proteinPoints.map(d => Number(d.protein)), borderWidth: 2, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 7 } } }
        }
      });
    }

    if (walkPoints.length) {
      walkChart = new Chart(ctxWalk, {
        type: "line",
        data: {
          labels: walkPoints.map(d => d.date),
          datasets: [
            { label: "Walk (min)", data: walkPoints.map(d => Number(d.walk)), borderWidth: 2, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 7 } } }
        }
      });
    }
  }

  function buildWeeklySummary() {
    if (!weeklySummaryDiv) return;
    const dataArr = getSortedDataArray();
    if (!dataArr.length) {
      weeklySummaryDiv.innerHTML = `
        <p class="notes-empty">
          Log a few days on the Home page to see your weekly coach summary.
        </p>
      `;
      return;
    }

    const last7 = dataArr.slice(-7);
    const n = last7.length;

    let totalWater = 0, totalProtein = 0, totalWalk = 0;
    let bestDay = null;
    let bestScore = -1;

    last7.forEach(d => {
      const w = Number(d.water) || 0;
      const p = Number(d.protein) || 0;
      const walk = Number(d.walk) || 0;
      totalWater += w;
      totalProtein += p;
      totalWalk += walk;

      let score = 0;
      if (w >= GOALS.water) score++;
      if (p >= GOALS.protein) score++;
      if (walk >= GOALS.walk) score++;
      if (score > bestScore) {
        bestScore = score;
        bestDay = d;
      }
    });

    const avgWater = Math.round(totalWater / n);
    const avgProtein = Math.round(totalProtein / n);
    const avgWalk = Math.round(totalWalk / n);

    let tip = "";
    if (avgWater < GOALS.water && avgProtein < GOALS.protein) {
      tip = "Hydration and protein both need love this week. Try sipping water all day and planning one protein-focused meal or shake.";
    } else if (avgWater < GOALS.water) {
      tip = "Water is a little low. Keep a bottle nearby and take a few sips every time you check your phone.";
    } else if (avgProtein < GOALS.protein) {
      tip = "Protein is slightly under goal. A small shake or snack can help you close the gap.";
    } else if (avgWalk < GOALS.walk) {
      tip = "Movement is the main opportunity. Even two 10-minute walks can make a big difference.";
    } else {
      tip = "You‚Äôre hitting your goals overall. Focus on staying consistent and listening to your body.";
    }

    const bestDayTxt = bestDay
      ? `${bestDay.date} ‚Äì you were especially on track.`
      : "Keep logging to see your standout days.";

    weeklySummaryDiv.innerHTML = `
      <strong>This week‚Äôs insight</strong>
      <ul class="weekly-list">
        <li>Average water: <strong>${avgWater} oz</strong></li>
        <li>Average protein: <strong>${avgProtein} g</strong></li>
        <li>Average walk: <strong>${avgWalk} min</strong></li>
        <li>Best day: ${bestDayTxt}</li>
      </ul>
      <p style="margin-top:6px;">${tip}</p>
    `;
  }

  function computeStreaks() {
    const allData = loadAllDataLocal();
    const dates = Object.keys(allData).sort();
    if (!dates.length) return null;

    let currentWater = 0, bestWater = 0;
    let currentProtein = 0, bestProtein = 0;
    let currentWalk = 0, bestWalk = 0;

    let prevDate = null;

    function isConsecutive(prev, current) {
      if (!prev) return false;
      const prevD = new Date(prev);
      const curD = new Date(current);
      const diffDays = Math.round((curD - prevD) / (1000 * 60 * 60 * 24));
      return diffDays === 1;
    }

    dates.forEach(date => {
      const d = allData[date];
      const meetsWater = (Number(d.water) || 0) >= GOALS.water;
      const meetsProtein = (Number(d.protein) || 0) >= GOALS.protein;
      const meetsWalk = (Number(d.walk) || 0) >= GOALS.walk;

      const consecutive = isConsecutive(prevDate, date);

      if (meetsWater) {
        currentWater = consecutive ? currentWater + 1 : 1;
      } else currentWater = 0;

      if (meetsProtein) {
        currentProtein = consecutive ? currentProtein + 1 : 1;
      } else currentProtein = 0;

      if (meetsWalk) {
        currentWalk = consecutive ? currentWalk + 1 : 1;
      } else currentWalk = 0;

      bestWater = Math.max(bestWater, currentWater);
      bestProtein = Math.max(bestProtein, currentProtein);
      bestWalk = Math.max(bestWalk, currentWalk);

      prevDate = date;
    });

    return {
      currentWater,
      bestWater,
      currentProtein,
      bestProtein,
      currentWalk,
      bestWalk,
      daysLogged: dates.length
    };
  }

  function buildStreaksUI() {
    if (!streaksSummaryDiv) return;
    const streaks = computeStreaks();
    if (!streaks) {
      streaksSummaryDiv.innerHTML = `
        <p class="notes-empty">
          Once you log a few days in a row, you‚Äôll see streaks and badges here.
        </p>
      `;
      return;
    }

    const {
      currentWater,
      bestWater,
      currentProtein,
      bestProtein,
      currentWalk,
      bestWalk,
      daysLogged
    } = streaks;

    const badges = [];

    if (bestWater >= 7) badges.push("üíß Hydration Hero (7+ days water goal)");
    if (bestProtein >= 10) badges.push("üçó Protein Pro (10+ days protein goal)");
    if (bestWalk >= 14) badges.push("üö∂ Moving Miracle (14+ days walk goal)");
    if (daysLogged >= 30) badges.push("üìÜ 30-Day Commitment");

    const badgesHTML = badges.length
      ? badges.map(b => `<span class="badge-pill">${b}</span>`).join("")
      : '<span class="notes-empty">No badges yet ‚Äì but you‚Äôre building them with every log.</span>';

    streaksSummaryDiv.innerHTML = `
      <strong>Streaks & Badges</strong>
      <div class="streak-grid">
        <div class="streak-item">
          <div><strong>Water streak</strong></div>
          <div>Current: ${currentWater} day(s)</div>
          <div>Best: ${bestWater} day(s)</div>
        </div>
        <div class="streak-item">
          <div><strong>Protein streak</strong></div>
          <div>Current: ${currentProtein} day(s)</div>
          <div>Best: ${bestProtein} day(s)</div>
        </div>
        <div class="streak-item">
          <div><strong>Walk streak</strong></div>
          <div>Current: ${currentWalk} day(s)</div>
          <div>Best: ${bestWalk} day(s)</div>
        </div>
      </div>
      <div class="badge-row" style="margin-top:8px;">
        ${badgesHTML}
      </div>
    `;
  }

  function updateJourneySummary(settings, dataArr) {
    if (!journeySummaryDiv) return;
    journeySummaryDiv.innerHTML = "";

    const surgeryDateStr = settings?.surgeryDate || "";
    const goalWeight = settings?.goalWeight ? Number(settings.goalWeight) : null;

    if (!surgeryDateStr || !goalWeight) {
      journeySummaryDiv.innerHTML = `
        <p class="notes-empty">
          Add your surgery date and goal weight above to see milestones here.
        </p>
      `;
      return;
    }

    const today = new Date();
    const surgeryDate = new Date(surgeryDateStr);
    const diffDays = Math.round((today - surgeryDate) / (1000 * 60 * 60 * 24));
    const diffMonths = Math.floor(diffDays / 30);

    if (!dataArr || !dataArr.length) {
      journeySummaryDiv.innerHTML = `
        <p><strong>${diffDays}</strong> day(s) since your surgery.</p>
        <p class="notes-empty">
          Start logging your weight to see how far you‚Äôve come toward your goal.
        </p>
      `;
      return;
    }

    const firstWeightEntry = dataArr.find(d => d.weight != null && !isNaN(Number(d.weight)));
    const lastWeightEntry = [...dataArr].reverse().find(d => d.weight != null && !isNaN(Number(d.weight)));

    if (!firstWeightEntry || !lastWeightEntry) {
      journeySummaryDiv.innerHTML = `
        <p><strong>${diffDays}</strong> day(s) since your surgery.</p>
        <p class="notes-empty">
          Once you log your weight, we‚Äôll show your total pounds lost and goal progress here.
        </p>
      `;
      return;
    }

    const startWeight = Number(firstWeightEntry.weight);
    const currentWeight = Number(lastWeightEntry.weight);
    const lost = startWeight - currentWeight;
    const totalToGoal = startWeight - goalWeight;
    let percentToGoal = 0;

    if (totalToGoal > 0) {
      percentToGoal = Math.max(0, Math.min(100, Math.round((lost / totalToGoal) * 100)));
    }

    let milestoneText = "";
    if (diffDays < 30) {
      milestoneText = "You‚Äôre in the very early healing days. Rest, hydrate, and take things slow.";
    } else if (diffDays < 90) {
      milestoneText = "You‚Äôre in the powerful first 3 months where habits start to build.";
    } else if (diffDays < 180) {
      milestoneText = "You‚Äôre moving into the long-game phase. Consistency is your superpower.";
    } else {
      milestoneText = "You‚Äôre deep into your journey. Look how far you‚Äôve already come.";
    }

    journeySummaryDiv.innerHTML = `
      <p><strong>${diffDays}</strong> day(s) since surgery (${diffMonths} month(s) approx).</p>
      <p><strong>${lost.toFixed(1)}</strong> lbs lost from your first logged weight (${startWeight} ‚Üí ${currentWeight}).</p>
      <p>Goal weight: <strong>${goalWeight} lbs</strong></p>
      <p>You‚Äôre about <strong>${percentToGoal}%</strong> of the way toward your goal.</p>
      <p style="margin-top:6px;">${milestoneText}</p>
    `;
  }

  // Toast helper
  function showToast(message) {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.add("show");
    setTimeout(() => {
      toastEl.classList.remove("show");
    }, 2200);
  }

  // Save / clear handlers
  saveBtn.addEventListener("click", async () => {
    if (!currentUser) {
      alert("Please log in again to save your VSG Buddy data.");
      return;
    }

    const dateStr = dateInput.value || getTodayString();

    const dayData = {
      water: Number(waterInput.value) || 0,
      protein: Number(proteinInput.value) || 0,
      weight: weightInput.value ? Number(weightInput.value) : null,
      walk: Number(walkInput.value) || 0,
      meds: medsInput.checked,
      notes: notesInput.value.trim()
    };

    const allData = loadAllDataLocal();
    allData[dateStr] = dayData;
    saveAllDataLocal(allData);
    updateSummary(dayData);
    updateProgressRings(dayData);

    try {
      await saveAllDataCloud(allData);
    } catch (e) {
      console.error("Failed to save cloud data:", e);
    }

    buildCharts();
    buildWeeklySummary();
    buildStreaksUI();
    updateJourneySummary(appSettings, getSortedDataArray());

    // Clear Today's Checklist fields (keep the date selected)
    waterInput.value = "";
    proteinInput.value = "";
    weightInput.value = "";
    walkInput.value = "";
    medsInput.checked = false;
    notesInput.value = "";

    showToast("Saved your VSG Buddy log for " + dateStr + "!");
  });

  clearBtn.addEventListener("click", async () => {
    const dateStr = dateInput.value || getTodayString();
    const allData = loadAllDataLocal();

    if (allData[dateStr]) {
      if (confirm("Are you sure you want to delete this day's data?")) {
        delete allData[dateStr];
        saveAllDataLocal(allData);

        if (currentUser) {
          try {
            await saveAllDataCloud(allData);
          } catch (e) {
            console.error("Failed to update cloud after delete:", e);
          }
        }

        await loadDataForDate(dateStr);
        buildCharts();
        buildWeeklySummary();
        buildStreaksUI();
        updateJourneySummary(appSettings, getSortedDataArray());
        showToast("Cleared data for " + dateStr);
      }
    } else {
      showToast("No data to clear for this date.");
    }
  });

  dateInput.addEventListener("change", async () => {
    const dateStr = dateInput.value;
    if (dateStr) await loadDataForDate(dateStr);
  });

  // PDF export
  if (downloadJsonBtn) {
    downloadJsonBtn.addEventListener("click", () => {
      const allData = loadAllDataLocal();
      const dates = Object.keys(allData).sort();

      if (!dates.length) {
        alert("No data to export yet.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("VSG Buddy Progress Report", 105, 12, { align: "center" });

      doc.setFontSize(10);
      let y = 22;

      dates.forEach((date) => {
        const d = allData[date];

        const line = `${date} ‚Äì ` +
          `W: ${d.weight != null ? d.weight : "-"} lbs | ` +
          `Water: ${d.water ?? 0} oz | ` +
          `Protein: ${d.protein ?? 0} g | ` +
          `Walk: ${d.walk ?? 0} min | ` +
          `Meds: ${d.meds ? "Yes" : "No"}`;

        if (y > 280) {
          doc.addPage();
          y = 20;
        }

        doc.text(line, 10, y);
        y += 7;
      });

      doc.save("vsg-buddy-report.pdf");
    });
  }

  // Backup / restore JSON
  if (backupJsonBtn) {
    backupJsonBtn.addEventListener("click", () => {
      const allData = loadAllDataLocal();
      const keys = Object.keys(allData);
      if (!keys.length) {
        alert("No data to backup yet.");
        return;
      }

      const json = JSON.stringify(allData, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "vsg-buddy-backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  if (restoreJsonInput) {
    restoreJsonInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (typeof imported !== "object" || imported === null || Array.isArray(imported)) {
            throw new Error("Invalid format");
          }

          const existing = loadAllDataLocal();
          const merged = { ...existing, ...imported };
          saveAllDataLocal(merged);

          if (currentUser) {
            try {
              await saveAllDataCloud(merged);
            } catch (err) {
              console.error("Failed to sync restored data to cloud:", err);
            }
          }

          alert("Backup restored! Your data has been merged.");
          const current = dateInput.value || getTodayString();
          await loadDataForDate(current);
          buildCharts();
          buildWeeklySummary();
          buildStreaksUI();
          updateJourneySummary(appSettings, getSortedDataArray());
        } catch (err) {
          console.error(err);
          alert("That file doesn't look like a valid VSG Buddy backup.");
        } finally {
          restoreJsonInput.value = "";
        }
      };
      reader.readAsText(file);
    });
  }

  // AUTH HANDLERS
  loginBtn.addEventListener("click", async () => {
    const email = authEmailInput.value.trim();
    const pass = authPasswordInput.value.trim();
    if (!email || !pass) {
      alert("Enter email and password.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      console.error(e);
      alert("Login failed: " + e.message);
    }
  });

  registerBtn.addEventListener("click", async () => {
    const email = authEmailInput.value.trim();
    const pass = authPasswordInput.value.trim();
    if (!email || !pass) {
      alert("Enter email and password.");
      return;
    }
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert("Account created and logged in!");
    } catch (e) {
      console.error(e);
      alert("Registration failed: " + e.message);
    }
  });

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
        alert("Logout failed: " + e.message);
      }
    });
  }

  function applyTheme(themeName) {
    const theme = THEMES[themeName] || THEMES.calm;
    const root = document.documentElement;
    Object.entries(theme).forEach(([key, value]) => {
      root.style.setProperty(key, value);
    });

    if (themeName === "midnight") {
      document.body.classList.add("dark-mode");
    } else {
      document.body.classList.remove("dark-mode");
    }

    themeButtons.forEach(btn => {
      if (btn.dataset.theme === themeName) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  themeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const themeName = btn.dataset.theme;
      const newSettings = { ...appSettings, theme: themeName };
      saveSettingsLocal(newSettings);
      applyTheme(themeName);
    });
  });

  if (saveJourneyBtn) {
    saveJourneyBtn.addEventListener("click", () => {
      const surgeryDate = surgeryDateInput.value || "";
      const goalWeightVal = goalWeightInput.value ? Number(goalWeightInput.value) : null;

      if (!surgeryDate || !goalWeightVal) {
        alert("Please enter both a surgery date and a goal weight.");
        return;
      }

      const newSettings = { ...appSettings, surgeryDate, goalWeight: goalWeightVal };
      saveSettingsLocal(newSettings);

      updateJourneySummary(newSettings, getSortedDataArray());
      showToast("Journey info saved.");
    });
  }

  // Donation prompt behavior
  function openDonationPrompt() {
    if (!donationPrompt) return;
    donationPrompt.classList.add("open");
  }

  function closeDonationPrompt() {
    if (!donationPrompt) return;
    donationPrompt.classList.remove("open");
  }

  function maybeShowDonationPrompt() {
    const hide = localStorage.getItem(DONATE_HIDE_KEY);
    if (hide === "true") return;
    setTimeout(() => {
      openDonationPrompt();
    }, 7000);
  }

  if (donationCloseBtn) {
    donationCloseBtn.addEventListener("click", () => {
      closeDonationPrompt();
    });
  }

  if (donationLaterBtn) {
    donationLaterBtn.addEventListener("click", () => {
      closeDonationPrompt();
    });
  }

  if (donationNeverBtn) {
    donationNeverBtn.addEventListener("click", () => {
      localStorage.setItem(DONATE_HIDE_KEY, "true");
      closeDonationPrompt();
    });
  }

  if (donationSupportBtn) {
    donationSupportBtn.addEventListener("click", () => {
      window.open("https://buymeacoffee.com/vsg.buddy", "_blank");
      closeDonationPrompt();
    });
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;

    if (currentUser) {
      if (topAuthStatus) topAuthStatus.textContent = currentUser.email || "Signed in";
      if (sideAuthStatus) sideAuthStatus.textContent = "Signed in as " + (currentUser.email || "");
      if (loginPage) loginPage.style.display = "none";
      if (appMain) appMain.style.display = "block";

      const cloudData = await loadAllDataCloud();
      const localData = loadAllDataLocal();
      const merged = { ...localData, ...cloudData };
      saveAllDataLocal(merged);

      const current = dateInput.value || getTodayString();
      await loadDataForDate(current);
      buildCharts();
      buildWeeklySummary();
      buildStreaksUI();
      updateJourneySummary(appSettings, getSortedDataArray());

      maybeShowDonationPrompt();
    } else {
      if (topAuthStatus) topAuthStatus.textContent = "Guest mode";
      if (sideAuthStatus) sideAuthStatus.textContent = "Not signed in";
      if (loginPage) loginPage.style.display = "flex";
      if (appMain) appMain.style.display = "none";
    }
  });

  (async function init() {
    const todayStr = getTodayString();
    if (dateInput) dateInput.value = todayStr;

    appSettings = loadSettingsLocal();
    applyTheme(appSettings.theme || "calm");

    if (appSettings.surgeryDate) {
      surgeryDateInput.value = appSettings.surgeryDate;
    }
    if (appSettings.goalWeight) {
      goalWeightInput.value = appSettings.goalWeight;
    }

    await loadDataForDate(todayStr);
    showPageById("homePage");
    updateQuote();
    buildCharts();
    buildWeeklySummary();
    buildStreaksUI();
    updateJourneySummary(appSettings, getSortedDataArray());
  })();

  // (Optional) PWA service worker registration, if you add sw.js later
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("/sw.js")
        .catch((err) => console.error("SW registration failed", err));
    });
  }
</script>
